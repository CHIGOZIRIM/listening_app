<!DOCTYPE html>
<html>
<head>
  <title>Continuous Bible Reference Finder</title>
</head>
<body>
<h2>Continuous Speech-to-Bible Reference</h2>
<div>Status: <span id="status">idle</span></div>
<button id="start-btn">Start Recording</button>
<button id="stop-btn" disabled>Stop Recording</button>
<h3>Transcript:</h3>
<pre id="transcript"></pre>
<h3>Possible Scriptures:</h3>
<pre id="results"></pre>

<script>
const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const statusEl = document.getElementById('status');
const transcriptEl = document.getElementById('transcript');
const resultsEl = document.getElementById('results');

let recognition = null;
let finalTranscript = '';
let interimTranscript = '';
let lastSent = '';

if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
  statusEl.innerText = 'Web Speech API unavailable';
  startBtn.disabled = true;
} else {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onstart = () => {
    statusEl.innerText = 'listening';
    startBtn.disabled = true;
    stopBtn.disabled = false;
  };

  recognition.onend = () => {
    statusEl.innerText = 'stopped';
    startBtn.disabled = false;
    stopBtn.disabled = true;
  };

  recognition.onerror = (e) => {
    statusEl.innerText = 'error: ' + e.error;
  };

  recognition.onresult = (event) => {
    interimTranscript = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i][0].transcript;
      if (event.results[i].isFinal) finalTranscript += res + ' ';
      else interimTranscript += res + ' ';
    }
    transcriptEl.innerText = finalTranscript + interimTranscript;
  };
}

// Send transcript to backend every 60 seconds
setInterval(async () => {
  const textToSend = (finalTranscript + interimTranscript).trim();
  if (textToSend && textToSend !== lastSent) {
    lastSent = textToSend;
    console.log("Sending transcript:", textToSend);  // <--- add this
    try {
      const response = await fetch("https://listening-app-4pdm.onrender.com", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({text: textToSend})
      });
      console.log("Fetch status:", response.status); // <--- add this
      const data = await response.json();
      console.log("Response JSON:", data);          // <--- add this
      resultsEl.innerText = data.matches.join('\n');
    } catch (err) {
      console.error("Failed to send transcript", err);
    }
  }
}, 60000);

startBtn.onclick = () => recognition && recognition.start();
stopBtn.onclick = () => recognition && recognition.stop();
</script>
